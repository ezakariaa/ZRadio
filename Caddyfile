z-radio.viewdns.net {

  # Headers de sécurité globaux
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "SAMEORIGIN"
    Referrer-Policy "strict-origin-when-cross-origin"
  }

  # ---- /status-json.xsl : proxy + en-têtes CORS sur la même route
  @status path /status-json.xsl*
  route @status {
    reverse_proxy 127.0.0.1:8000 {
      transport http {
        dial_timeout 5s
        response_header_timeout 10s
      }
    }

    header {
      -Access-Control-Allow-Origin
      -Access-Control-Allow-Methods
      -Access-Control-Allow-Headers
      Access-Control-Allow-Origin  "*"
      Access-Control-Allow-Methods "GET, OPTIONS"
      Access-Control-Allow-Headers "*"
      Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
      Vary "Origin"
    }
  }

  # Préflight CORS propre
  @preflight {
    method OPTIONS
    path /status-json.xsl*
  }
  respond @preflight 204

  # ---- Routes pour les fichiers JSON de métadonnées
  @json path /*.json
  route @json {
    reverse_proxy 127.0.0.1:8000 {
      transport http {
        dial_timeout 5s
        response_header_timeout 10s
      }
    }
    
    header {
      Access-Control-Allow-Origin "*"
      Access-Control-Allow-Methods "GET, OPTIONS"
      Access-Control-Allow-Headers "*"
      Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
    }
  }

  # Préflight CORS pour JSON
  @preflight_json {
    method OPTIONS
    path /*.json
  }
  respond @preflight_json 204

  # ---- Flux audio : configuration optimisée pour streaming
  # Timeouts généreux pour éviter les coupures intermittentes
  @stream path /stream
  route @stream {
    reverse_proxy 127.0.0.1:8000 {
      # Pas de buffering pour les flux en temps réel
      flush_interval -1
      
      # Configuration très tolérante pour les flux audio (éviter timeout/buffering)
      transport http {
        versions 1.1
        dial_timeout 10s
        response_header_timeout 30s
        read_timeout 24h
        write_timeout 24h
      }
      
      # Headers spécifiques pour le streaming
      # X-Forwarded-For est automatiquement ajouté par Caddy, pas besoin de le spécifier
      header_up X-Real-IP {remote_host}
      
      # Préserver les headers de réponse d'Icecast (notamment Content-Type)
      # Ne pas modifier les headers de réponse du serveur en amont
      # Les headers seront préservés automatiquement si on ne les écrase pas
      
      # Gestion des erreurs avec health checks (désactivés pour éviter les délais)
      # health_uri /status-json.xsl
      # health_interval 30s
      # health_timeout 5s
      # fail_duration 10s
      # max_fails 3
      # unhealthy_status 503
    }
    
    # Headers spécifiques pour le streaming audio
    # IMPORTANT: Ne pas définir Content-Type ici pour préserver celui d'Icecast
    header {
      Access-Control-Allow-Origin "*"
      Access-Control-Allow-Methods "GET, HEAD, OPTIONS"
      Access-Control-Allow-Headers "Range, Content-Type, Accept"
      Access-Control-Expose-Headers "Content-Length, Content-Range"
      # Ne PAS définir Content-Type - laisser Icecast le définir
      # Si Caddy ajoute automatiquement un Content-Type, on peut le supprimer avec:
      # -Content-Type
      Accept-Ranges "bytes"
      Connection "keep-alive"
      # Pas de limite de taille pour les streams
      -Content-Length
      Cache-Control "no-cache, no-store, must-revalidate"
    }
  }

  # Préflight CORS pour le flux
  @preflight_stream {
    method OPTIONS
    path /stream
  }
  respond @preflight_stream 204

  # ---- Cache pour les fichiers statiques
  @static {
    path /cover.*
    path /intro.mp3
    path /*.html
    path /*.css
    path /*.js
    path /*.gif
    path /*.png
  }
  header @static {
    Cache-Control "public, max-age=3600"
  }

  # ---- Le reste du site (fichiers statiques et autres)
  route {
    # Encodage automatique pour les fichiers statiques uniquement
    encode zstd gzip
    
    reverse_proxy 127.0.0.1:8000 {
      transport http {
        dial_timeout 5s
        response_header_timeout 10s
      }
    }
  }

  # Logging: Caddy émet ces warnings au niveau WARN pour les flux audio streaming
  # Ces messages sont NORMALUX et indiquent que :
  # - Un client a fermé la connexion (changement de page, fermeture d'onglet, etc.)
  # - Caddy annule proprement la connexion en amont vers Icecast
  # 
  # Ce n'est PAS un blocage - c'est le comportement attendu pour les streams.
  # 
  # Options pour réduire ces messages:
  # 1. Accepter les warnings (recommandé - ils n'affectent pas le fonctionnement)
  # 2. Filtrer avec un outil externe (grep -v "context canceled" ou "aborting with incomplete")
  # 3. Désactiver les logs WARN pour le reverse_proxy (voir ci-dessous)
  
  # Option actuelle: Logs complets (INFO, WARN, ERROR)
  # Pour désactiver TOUS les logs, décommentez:
  # log { output discard }
  
  # Pour désactiver uniquement les WARN du reverse_proxy (recommandé pour les streams):
  # log {
  #   output discard
  #   level WARN
  #   format filter {
  #     exclude "http.handlers.reverse_proxy"
  #   }
  # }
  
  # Note: Ces warnings sont normaux et peuvent être ignorés en toute sécurité.
  # Ils indiquent simplement qu'un client a fermé sa connexion au flux audio.

}
