<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Z Radio â€“ Live Stream</title>
  <style>
    :root { --accent:#1db954; --bg1:#0e0e0e; --bg2:#232526; }
    *{ box-sizing:border-box; margin:0; padding:0; }
    body{
      min-height:100vh; display:flex; justify-content:center; align-items:center; flex-direction:column;
      font-family:system-ui, sans-serif; background:linear-gradient(145deg,var(--bg1),var(--bg2));
      color:#f5f5f5; text-align:center; padding:1.2rem;
    }
    h1{ font-size:2.6rem; color:var(--accent); margin-bottom:.2em; }
    small{ color:#aaa; }
    #coverWrapper{
      width:220px; height:220px; border-radius:8px; box-shadow:0 4px 16px rgba(0,0,0,.4);
      margin:1.3em 0 .8em; overflow:hidden;
    }
    img#cover{ width:100%; height:100%; object-fit:cover; display:block; }
    audio{ width:220px; height:40px; margin-bottom:1em; filter:drop-shadow(0 2px 4px rgba(0,0,0,.5)); }
    .meta{ font-size:1.05rem; margin-top:.3em; }
    #listeners{ font-size:.9rem; color:#ccc; margin-top:.2em; }
    footer{ margin-top:2.5rem; font-size:.8rem; color:#888; }
    a{ color:var(--accent); }
    .song-title{ font-weight:bold; font-size:1rem; }
    .artist-name{ margin-top:.2em; color:#aaa; font-size:1rem; }
    #status{ margin-top:.6rem; font-size:.9rem; color:#ffd166; min-height:1.1em; }
  </style>
</head>
<body>

  <h1>ðŸŽµ Z Radio</h1>
  <small>Musique 24 / 7 â€“ Hits & Classics</small>

  <div id="coverWrapper">
    <img id="cover" src="cover.gif" alt="Pochette de l'album">
  </div>

  <!-- DÃ©marrage plus rapide : on autorise un prÃ©-buffer -->
  <audio id="player" controls preload="auto">
    <source id="src" src="https://z-radio.viewdns.net/stream" type="audio/mpeg">
    Votre navigateur ne supporte pas l'audio HTML5.
  </audio>

  <div id="title" class="meta song-title">Chargementâ€¦</div>
  <div id="artist" class="artist-name"></div>
  <div id="listeners">Auditeurs : --</div>
  <div id="status"></div>

  <footer>
    Â© 2025 <span style="color:var(--accent)">Z Radio</span> â€“ Created by <span style="color:var(--accent)">Zakaria ELORCHE</span><br/>
    Powered by <a href="https://icecast.org" target="_blank" rel="noopener">Icecast 2</a>
  </footer>

  <script>
    // ---- config
    const ICECAST_BASE = "https://z-radio.viewdns.net:8000";
    const STATUS_URL   = ICECAST_BASE + "/status-json.xsl";
    const MOUNT        = "/stream";
    const FALLBACK_IMG = "cover.gif";

    // ---- dom
    const player   = document.getElementById("player");
    const srcEl    = document.getElementById("src");
    const coverEl  = document.getElementById("cover");
    const titleEl  = document.getElementById("title");
    const artistEl = document.getElementById("artist");
    const listEl   = document.getElementById("listeners");
    const statusEl = document.getElementById("status");

    let lastTitle = "";

    // ---- util
    function pickSource(icestats) {
      let s = icestats?.source;
      if (!s) return null;
      if (Array.isArray(s)) {
        // on prÃ©fÃ¨re le mount /stream ou la source avec des auditeurs
        return s.find(o => (o.listenurl||"").endsWith(MOUNT)) || s.find(o => (o.listeners||0) > 0) || s[0];
      }
      return s;
    }

    async function fetchCoverItunes(query) {
      const r = await fetch("https://itunes.apple.com/search?term=" + encodeURIComponent(query) + "&limit=1&media=music");
      const d = await r.json();
      const art = d?.results?.[0]?.artworkUrl100;
      return art ? art.replace("100x100","600x600") : null;
    }

    async function setCover(query) {
      try {
        const url = await fetchCoverItunes(query);
        coverEl.src = url || FALLBACK_IMG;
      } catch { coverEl.src = FALLBACK_IMG; }
    }

    async function refresh() {
      try {
        const r = await fetch(STATUS_URL, { cache:"no-store" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        const data = await r.json();

        const src = pickSource(data.icestats);
        if (!src) throw new Error("Aucune source");

        // auditeurs
        listEl.textContent = "Auditeurs : " + (src.listeners ?? 0);

        // titre + artiste
        const raw = src.title || "";
        if (raw && raw !== lastTitle) {
          lastTitle = raw;
          let artist = "", title = raw;

          if (raw.includes(" â€“ "))       [artist, title] = raw.split(" â€“ ").map(s=>s.trim());
          else if (raw.includes(" - "))  [artist, title] = raw.split(" - ").map(s=>s.trim());

          titleEl.textContent  = title || "En direct";
          artistEl.textContent = artist || "";

          setCover((artist ? artist + " " : "") + title);
        }

        statusEl.textContent = "";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Flux indisponibleâ€¦";
        coverEl.src = FALLBACK_IMG;
      }
    }

    // force lâ€™URL lecture cÃ´tÃ© client (on ignore listenurl du JSON)
    srcEl.src = ICECAST_BASE + MOUNT;

    // premier fetch + polling rÃ©gulier
    refresh();
    setInterval(refresh, 15000);

    // si la lecture tombe en erreur rÃ©seau, on relie la source et on recharge
    player.addEventListener("error", () => {
      srcEl.src = ICECAST_BASE + MOUNT;
      player.load();
    });
  </script>
</body>
</html>
