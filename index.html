<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Z Radio â€“ Live Stream</title>
  <style>
    :root {
      --accent: #1db954;
      --bg1: #0e0e0e;
      --bg2: #232526;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
      font-family: system-ui, sans-serif;
      background: linear-gradient(145deg, var(--bg1), var(--bg2));
      color: #f5f5f5;
      text-align: center;
      padding: 1.2rem;
    }
    h1 { font-size: 2.6rem; color: var(--accent); margin-bottom: .2em; }
    small { color: #aaa; }
    #coverWrapper {
      width: 220px; height: 220px; border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0,0,0,.4);
      margin: 1.3em 0 .8em;
      overflow: hidden;
    }
    img#cover {
      width: 100%; height: 100%; object-fit: cover;
      display: block;
    }
    audio {
      width: 220px; height: 40px;
      margin-bottom: 1em;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,.5));
    }
    .meta { font-size: 1.05rem; margin-top: .3em; }
    #listeners { font-size: .9rem; color: #ccc; margin-top: .2em; }
    footer { margin-top: 2.5rem; font-size: .8rem; color: #888; }
    a { color: var(--accent); }
    .song-title { font-weight: bold; font-size: 1rem; }
    .artist-name { margin-top: 0.2em; color: #aaa; font-size: 1rem; }
    .radio-info { margin-top: 0.5em; color: #ddd; font-size: 0.9rem; }
  </style>
</head>
<body>

  <h1>ðŸŽµ Z Radio</h1>
  <small>Musique 24 / 7 â€“ Hits & Classics</small>

  <div id="coverWrapper">
    <img id="cover" src="cover.gif" alt="Pochette de l'album">
  </div>

  <audio id="player" controls preload="none">
    <source src="https://stream-eurodance90.fr/radio/8000/128.mp3" type="audio/mpeg">
    Votre navigateur ne supporte pas l'audio HTML5.
  </audio>

  <div id="radio-name" class="radio-info">Eurodance 90</div>
  <div id="title" class="meta song-title">En direct</div>
  <div id="artist" class="artist-name">La radio dance 90</div>
  <div id="listeners">Auditeurs : --</div>

  <footer>
    Â© 2025 <span style="color:var(--accent)">Z Radio</span> â€“ Created by <span style="color:var(--accent)">Zakaria ELORCHE</span><br/>
    Powered by <a href="https://icecast.org" target="_blank" rel="noopener">Icecast 2</a>
  </footer>

  <script>
    const statusURL = "http://radiart.eu:8394/status-json.xsl"; 
    const player = document.getElementById("player");
    const coverImg = document.getElementById("cover");
    const radioNameEl = document.getElementById("radio-name");
    const titleEl = document.getElementById("title");
    const artistEl = document.getElementById("artist");
    const listenersEl = document.getElementById("listeners");
    let refreshInterval;

    async function fetchRadioStatus() {
      try {
        // Solution CORS alternative si nÃ©cessaire
        const corsProxy = "https://api.allorigins.win/raw?url=";
        const response = await fetch(corsProxy + encodeURIComponent(statusURL), {
          cache: "no-store"
        });

        if (!response.ok) throw new Error(`Erreur HTTP: ${response.status}`);

        const data = await response.json();
        
        if (!data?.icestats?.source) {
          throw new Error("Structure de donnÃ©es invalide");
        }

        // Trouver la source principale (celle avec des auditeurs)
        const mainSource = data.icestats.source.find(source => source.listeners > 0) || 
                          data.icestats.source[0];

        if (!mainSource) throw new Error("Aucune source valide trouvÃ©e");

        return {
          radioName: mainSource.server_name || "Radio inconnue",
          title: mainSource.title || "En direct",
          listeners: mainSource.listeners || 0,
          genre: mainSource.genre || "Musique"
        };
      } catch (error) {
        console.error("Erreur de rÃ©cupÃ©ration du statut:", error);
        throw error;
      }
    }

    function updateDisplay(data) {
      // Extraire artiste et titre si possible (adaptÃ© Ã  votre format)
      const titleParts = data.title.split(" - ");
      const displayTitle = titleParts.length > 1 ? titleParts[1] : data.title;
      const displayArtist = titleParts.length > 1 ? titleParts[0] : data.radioName;

      radioNameEl.textContent = data.radioName;
      titleEl.textContent = displayTitle;
      artistEl.textContent = displayArtist;
      listenersEl.textContent = `Auditeurs : ${data.listeners}`;
      
      // Mettre Ã  jour la cover si nÃ©cessaire
      if (displayArtist && displayTitle && displayTitle !== "En direct") {
        updateCover(displayArtist, displayTitle);
      }
    }

    async function updateCover(artist, title) {
      try {
        const coverUrl = await fetchCoverItunes(`${artist} ${title}`);
        coverImg.src = coverUrl;
      } catch {
        coverImg.src = "cover.gif";
      }
    }

    async function fetchCoverItunes(query) {
      try {
        const res = await fetch(`https://itunes.apple.com/search?term=${encodeURIComponent(query)}&limit=1&media=music`);
        const data = await res.json();
        return data.results?.[0]?.artworkUrl100?.replace("100x100", "600x600") || "cover.gif";
      } catch {
        return "cover.gif";
      }
    }

    async function refresh() {
      try {
        const status = await fetchRadioStatus();
        updateDisplay(status);
      } catch (error) {
        console.error("Refresh error:", error);
        radioNameEl.textContent = "Eurodance 90";
        titleEl.textContent = "Flux indisponible";
        artistEl.textContent = "Connexion en cours...";
        listenersEl.textContent = "Auditeurs : --";
        coverImg.src = "cover.gif";
        
        // RÃ©essayer aprÃ¨s 30 secondes
        setTimeout(refresh, 30000);
      }
    }

    function setupPlayer() {
      // Premier refresh immÃ©diat
      refresh();
      
      // Mettre en place l'intervalle de refresh
      refreshInterval = setInterval(refresh, 10000);
      
      // Nettoyer Ã  la fermeture
      window.addEventListener('beforeunload', () => {
        clearInterval(refreshInterval);
      });
    }

    // DÃ©marrer au chargement
    document.addEventListener('DOMContentLoaded', setupPlayer);
    player.addEventListener("play", setupPlayer, { once: true });
  </script>
</body>
</html>
